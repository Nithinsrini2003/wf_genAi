# compare.py
import yaml
import jsonref
import os

def load_yaml_with_refs(yaml_path: str):
    base_path = os.path.dirname(yaml_path)
    def loader(uri):
        full_path = os.path.join(base_path, uri)
        with open(full_path, 'r') as f:
            return yaml.safe_load(f)
    with open(yaml_path, 'r') as f:
        root_data = yaml.safe_load(f)
    return jsonref.JsonRef.replace_refs(root_data, loader=loader)

def build_endpoint_map(root_yaml_path: str):
    resolved = load_yaml_with_refs(root_yaml_path)
    paths = resolved.get("paths", {})
    endpoint_map = {}
    for path, methods in paths.items():
        for method, details in methods.items():
            entry = dict(details)
            entry["method"] = method.lower()
            endpoint_map[path] = entry
    return endpoint_map
